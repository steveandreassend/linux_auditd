## Table 3: LOLBins Used for Discovery [TA0007]
##   Ref: https://attack.mitre.org/tactics/TA0007/

## The adversary is trying to figure out your environment.

## Discovery consists of techniques an adversary may use to gain knowledge about the system and internal
## network. These techniques help adversaries observe the environment and orient themselves before deciding
## how to act. They also allow adversaries to explore what they can control and whatâ€™s around their entry
## point in order to discover how it could benefit their current objective. Native operating system tools
## are often used toward this post-compromise information-gathering objective.

## T1016 - System Network Configuration Discovery
##   Ref: https://attack.mitre.org/techniques/T1016/


#############################################
## T1016 - System Network Configuration Discovery
##   Ref: https://attack.mitre.org/techniques/T1016/

## Adversaries may look for details about the network configuration and settings, such as IP and/or MAC addresses,
## of systems they access or through information discovery of remote systems. Several operating system administration
## utilities exist that can be used to gather this information. Examples include Arp, ipconfig/ifconfig, nbtstat, and route.

## Adversaries may also leverage a Network Device CLI on network devices to gather information about configurations
## and settings, such as IP addresses of configured interfaces and static/dynamic routes (e.g. show ip route, show ip interface).

## Adversaries may use the information from System Network Configuration Discovery during automated discovery to shape follow-on
## behaviors, including determining certain access within the target network and what actions to do next.

## Monitor execution of common network discovery commands
-a always,exit -F arch=b64 -S execve -F comm=ifconfig -F auid>=1000 -F auid!=4294967295 -k T1016_Network_Discovery
-a always,exit -F arch=b64 -S execve -F comm=ip -F auid>=1000 -F auid!=4294967295 -k T1016_Network_Discovery
-a always,exit -F arch=b64 -S execve -F comm=route -F auid>=1000 -F auid!=4294967295 -k T1016_Network_Discovery
-a always,exit -F arch=b64 -S execve -F comm=netstat -F auid>=1000 -F auid!=4294967295 -k T1016_Network_Discovery
-a always,exit -F arch=b64 -S execve -F comm=ss -F auid>=1000 -F auid!=4294967295 -k T1016_Network_Discovery
-a always,exit -F arch=b64 -S execve -F comm=hostname -F auid>=1000 -F auid!=4294967295 -k T1016_Network_Discovery
-a always,exit -F arch=b64 -S execve -F comm=arp -F auid>=1000 -F auid!=4294967295 -k T1016_Network_Discovery
-a always,exit -F arch=b64 -S execve -F comm=nmcli -F auid>=1000 -F auid!=4294967295 -k T1016_Network_Discovery
-a always,exit -F arch=b64 -S execve -F comm=resolvectl -F auid>=1000 -F auid!=4294967295 -k T1016_Network_Discovery

## Monitor execution of DNS resolution commands
-a always,exit -F arch=b64 -S execve -F comm=nslookup -F auid>=1000 -F auid!=4294967295 -k T1016_DNS_Resolution
-a always,exit -F arch=b64 -S execve -F comm=dig -F auid>=1000 -F auid!=4294967295 -k T1016_DNS_Resolution
-a always,exit -F arch=b64 -S execve -F comm=host -F auid>=1000 -F auid!=4294967295 -k T1016_DNS_Resolution

## Monitor modifications to network configuration files
-w /etc/network/ -p wa -k T1016_Network_Config_Modification
-w /etc/sysconfig/network -p wa -k T1016_Network_Config_Modification
-w /etc/sysconfig/network-scripts/ -p wa -k T1016_Network_Config_Modification
## -w /etc/resolv.conf -p wa -k T1016_DNS_Config_Modification
## -w /etc/hosts -p wa -k T1016_DNS_Config_Modification
## Covered by TA0005
-w /etc/hostname -p wa -k T1016_Hostname_Modification

## Monitor execution of firewall-related commands
-a always,exit -F arch=b64 -S execve -F comm=iptables -F auid>=1000 -F auid!=4294967295 -k T1016_Firewall_Discovery
-a always,exit -F arch=b64 -S execve -F comm=nft -F auid>=1000 -F auid!=4294967295 -k T1016_Firewall_Discovery
-a always,exit -F arch=b64 -S execve -F comm=firewall-cmd -F auid>=1000 -F auid!=4294967295 -k T1016_Firewall_Discovery
-a always,exit -F arch=b64 -S execve -F comm=ufw -F auid>=1000 -F auid!=4294967295 -k T1016_Firewall_Discovery


#############################################
## T1083 - File and Directory Discovery
##   Ref: https://attack.mitre.org/techniques/T1083/

## Adversaries may enumerate files and directories or may search in specific locations of a host or network share
## for certain information within a file system. Adversaries may use the information from File and Directory Discovery
## during automated discovery to shape follow-on behaviors, including whether or not the adversary fully infects
## the target and/or attempts specific actions.

## Many command shell utilities can be used to obtain this information. Examples include dir, tree, ls, find,
## and locate. Custom tools may also be used to gather file and directory information and interact with the
## Native API. Adversaries may also leverage a Network Device CLI on network devices to gather file and directory
## information (e.g. dir, show flash, and/or nvram).

## Some files and directories may require elevated or specific user permissions to access.

## Monitor execution of common file and directory discovery commands
-a always,exit -F arch=b64 -S execve -F comm=find -F auid>=1000 -F auid!=4294967295 -k T1083_File_Discovery
-a always,exit -F arch=b64 -S execve -F comm=ls -F auid>=1000 -F auid!=4294967295 -k T1083_File_Discovery
-a always,exit -F arch=b64 -S execve -F comm=tree -F auid>=1000 -F auid!=4294967295 -k T1083_File_Discovery
-a always,exit -F arch=b64 -S execve -F comm=locate -F auid>=1000 -F auid!=4294967295 -k T1083_File_Discovery
-a always,exit -F arch=b64 -S execve -F comm=du -F auid>=1000 -F auid!=4294967295 -k T1083_File_Discovery
-a always,exit -F arch=b64 -S execve -F comm=stat -F auid>=1000 -F auid!=4294967295 -k T1083_File_Discovery
## If this generates too many logs from whitelisted scripts, consider suppressing the user IDs in the audit rule

## Monitor access to sensitive directories
##-w /root/ -p r -k T1083_Sensitive_Directory_Access
##-w /home/ -p r -k T1083_Sensitive_Directory_Access
##-w /etc/ -p r -k T1083_System_Config_Access
##-w /var/log/ -p r -k T1083_Log_File_Access
##-w /tmp/ -p r -k T1083_Temp_File_Access
## This will generate too many logs

## Monitor execution of file search and indexing commands
-a always,exit -F arch=b64 -S execve -F comm=updatedb -F auid>=1000 -F auid!=4294967295 -k T1083_File_Indexing
-a always,exit -F arch=b64 -S execve -F comm=grep -F auid>=1000 -F auid!=4294967295 -k T1083_File_Search

## Monitor modifications to system directories
## -w /etc/passwd -p wa -k T1083_System_File_Modification
## -w /etc/shadow -p wa -k T1083_System_File_Modification
## -w /etc/group -p wa -k T1083_System_File_Modification
## -w /etc/sudoers -p wa -k T1083_System_File_Modification
## Covered by TA0006

## Monitor execution of file metadata inspection commands
-a always,exit -F arch=b64 -S execve -F comm=file -F auid>=1000 -F auid!=4294967295 -k T1083_File_Metadata_Inspection
-a always,exit -F arch=b64 -S execve -F comm=lsattr -F auid>=1000 -F auid!=4294967295 -k T1083_File_Metadata_Inspection
-a always,exit -F arch=b64 -S execve -F comm=stat -F auid>=1000 -F auid!=4294967295 -k T1083_File_Metadata_Inspection


#############################################
## T1518 - Software Discovery
##   Ref: https://attack.mitre.org/techniques/T1518/

## Adversaries may attempt to get a listing of software and software versions that are installed on a system or in a
## cloud environment. Adversaries may use the information from Software Discovery during automated discovery to shape
## follow-on behaviors, including whether or not the adversary fully infects the target and/or attempts specific actions.

## Such software may be deployed widely across the environment for configuration management or security reasons,
## such as Software Deployment Tools, and may allow adversaries broad access to infect devices or move laterally.

## Adversaries may attempt to enumerate software for a variety of reasons, such as figuring out what security measures
## are present or if the compromised system has a version of software that is vulnerable to Exploitation for Privilege Escalation.

## Monitor execution of common software discovery commands
-a always,exit -F arch=b64 -S execve -F comm=dpkg -F auid>=1000 -F auid!=4294967295 -k T1518_Software_Discovery
-a always,exit -F arch=b64 -S execve -F comm=rpm -F auid>=1000 -F auid!=4294967295 -k T1518_Software_Discovery
-a always,exit -F arch=b64 -S execve -F comm=yum -F auid>=1000 -F auid!=4294967295 -k T1518_Software_Discovery
-a always,exit -F arch=b64 -S execve -F comm=dnf -F auid>=1000 -F auid!=4294967295 -k T1518_Software_Discovery
-a always,exit -F arch=b64 -S execve -F comm=apt -F auid>=1000 -F auid!=4294967295 -k T1518_Software_Discovery
-a always,exit -F arch=b64 -S execve -F comm=apt-get -F auid>=1000 -F auid!=4294967295 -k T1518_Software_Discovery
-a always,exit -F arch=b64 -S execve -F comm=zypper -F auid>=1000 -F auid!=4294967295 -k T1518_Software_Discovery
-a always,exit -F arch=b64 -S execve -F comm=pacman -F auid>=1000 -F auid!=4294967295 -k T1518_Software_Discovery

## Monitor execution of system inspection commands
-a always,exit -F arch=b64 -S execve -F comm=uname -F auid>=1000 -F auid!=4294967295 -k T1518_System_Inspection
-a always,exit -F arch=b64 -S execve -F comm=lsb_release -F auid>=1000 -F auid!=4294967295 -k T1518_System_Inspection
-a always,exit -F arch=b64 -S execve -F comm=cat -F auid>=1000 -F auid!=4294967295 -k T1518_System_Inspection

## Monitor access to files containing software information
-w /var/lib/rpm/ -p r -k T1518_Package_Inspection
-w /var/lib/dpkg/ -p r -k T1518_Package_Inspection
-w /etc/lsb-release -p r -k T1518_System_Inspection
-w /etc/redhat-release -p r -k T1518_System_Inspection
-w /etc/os-release -p r -k T1518_System_Inspection

## Monitor execution of user enumeration commands (may be part of software reconnaissance)
-a always,exit -F arch=b64 -S execve -F comm=id -F auid>=1000 -F auid!=4294967295 -k T1518_User_Discovery
-a always,exit -F arch=b64 -S execve -F comm=whoami -F auid>=1000 -F auid!=4294967295 -k T1518_User_Discovery
-a always,exit -F arch=b64 -S execve -F comm=w -F auid>=1000 -F auid!=4294967295 -k T1518_User_Discovery
-a always,exit -F arch=b64 -S execve -F comm=who -F auid>=1000 -F auid!=4294967295 -k T1518_User_Discovery


#############################################
## T1007 - System Service Discovery
##   Ref: https://attack.mitre.org/techniques/T1007/

## Adversaries may try to gather information about registered local system services. Adversaries may obtain
## information about services using tools as well as OS utility commands such as sc query, tasklist /svc,
## systemctl --type=service, and net start.

## Adversaries may use the information from System Service Discovery during automated discovery to shape
## follow-on behaviors, including whether or not the adversary fully infects the target and/or attempts specific actions.

## - Monitor execution of service discovery commands
##-a always,exit -F arch=b64 -S execve -F comm=systemctl -F auid>=1000 -F auid!=4294967295 -k T1007_Service_Discovery
##-a always,exit -F arch=b64 -S execve -F comm=service -F auid>=1000 -F auid!=4294967295 -k T1007_Service_Discovery
##-a always,exit -F arch=b64 -S execve -F comm=chkconfig -F auid>=1000 -F auid!=4294967295 -k T1007_Service_Discovery
## Covered by TA0003
-a always,exit -F arch=b64 -S execve -F comm=rc-status -F auid>=1000 -F auid!=4294967295 -k T1007_Service_Discovery

## Monitor access to service configuration files
## -w /etc/systemd/system/ -p r -k T1007_Service_Config_Access
## -w /usr/lib/systemd/system/ -p r -k T1007_Service_Config_Access
## -w /etc/init.d/ -p r -k T1007_Service_Config_Access
## -w /etc/rc.d/ -p r -k T1007_Service_Config_Access
## Covered by TA0003
-w /etc/xinetd.d/ -p r -k T1007_Service_Config_Access

## Monitor execution of network service discovery commands
-a always,exit -F arch=b64 -S execve -F comm=netstat -F auid>=1000 -F auid!=4294967295 -k T1007_Network_Service_Discovery
-a always,exit -F arch=b64 -S execve -F comm=ss -F auid>=1000 -F auid!=4294967295 -k T1007_Network_Service_Discovery
-a always,exit -F arch=b64 -S execve -F comm=lsof -F auid>=1000 -F auid!=4294967295 -k T1007_Network_Service_Discovery

## Monitor execution of commands listing active services
-a always,exit -F arch=b64 -S execve -F comm=ps -F auid>=1000 -F auid!=4294967295 -k T1007_Process_Discovery
-a always,exit -F arch=b64 -S execve -F comm=top -F auid>=1000 -F auid!=4294967295 -k T1007_Process_Discovery
-a always,exit -F arch=b64 -S execve -F comm=htop -F auid>=1000 -F auid!=4294967295 -k T1007_Process_Discovery


#############################################
## T1057 - Process Discovery
##   Ref: https://attack.mitre.org/techniques/T1057/

## Adversaries may attempt to get information about running processes on a system. Information obtained could be
## used to gain an understanding of common software/applications running on systems within the network. Administrator
## or otherwise elevated access may provide better process details. Adversaries may use the information from Process
## Discovery during automated discovery to shape follow-on behaviors, including whether or not the adversary fully
## infects the target and/or attempts specific actions.

## In Windows environments, adversaries could obtain details on running processes using the Tasklist utility via cmd or
## Get-Process via PowerShell. Information about processes can also be extracted from the output of Native API calls such
## as CreateToolhelp32Snapshot. In Mac and Linux, this is accomplished with the ps command. Adversaries may also opt to enumerate processes via /proc.

## On network devices, Network Device CLI commands such as show processes can be used to display current running processes

## Monitor execution of process discovery commands
##-a always,exit -F arch=b64 -S execve -F comm=ps -F auid>=1000 -F auid!=4294967295 -k T1057_Process_Discovery
##-a always,exit -F arch=b64 -S execve -F comm=top -F auid>=1000 -F auid!=4294967295 -k T1057_Process_Discovery
##-a always,exit -F arch=b64 -S execve -F comm=htop -F auid>=1000 -F auid!=4294967295 -k T1057_Process_Discovery
## Covered by T1007
-a always,exit -F arch=b64 -S execve -F comm=pgrep -F auid>=1000 -F auid!=4294967295 -k T1057_Process_Discovery
-a always,exit -F arch=b64 -S execve -F comm=pidof -F auid>=1000 -F auid!=4294967295 -k T1057_Process_Discovery

## Monitor execution of system introspection commands
##-a always,exit -F arch=b64 -S execve -F comm=lsof -F auid>=1000 -F auid!=4294967295 -k T1057_Process_Introspection
## Covered by T1007
-a always,exit -F arch=b64 -S execve -F comm=strace -F auid>=1000 -F auid!=4294967295 -k T1057_Process_Introspection
##-a always,exit -F arch=b64 -S execve -F comm=gdb -F auid>=1000 -F auid!=4294967295 -k T1057_Process_Introspection
## Covered by TA0006

## Monitor execution of process inspection commands
-a always,exit -F arch=b64 -S execve -F comm=procinfo -F auid>=1000 -F auid!=4294967295 -k T1057_Process_Inspection
-a always,exit -F arch=b64 -S execve -F comm=pstree -F auid>=1000 -F auid!=4294967295 -k T1057_Process_Inspection
-a always,exit -F arch=b64 -S execve -F comm=watch -F auid>=1000 -F auid!=4294967295 -k T1057_Process_Inspection

## Monitor access to process-related files and directories
-w /proc/ -p r -k T1057_Process_Proc_Access
-w /proc/*/status -p r -k T1057_Process_Proc_Access
-w /proc/*/cmdline -p r -k T1057_Process_Proc_Access
-w /proc/*/exe -p r -k T1057_Process_Proc_Access
## -w /proc/*/maps -p r -k T1057_Process_Proc_Access
## Covered by TA0006


#############################################
## T1033 - System Owner/User Discovery
##   Ref: https://attack.mitre.org/techniques/T1033/

## Adversaries may attempt to identify the primary user, currently logged in user, set of users that commonly
## uses a system, or whether a user is actively using the system. They may do this, for example, by retrieving
## account usernames or by using OS Credential Dumping. The information may be collected in a number of different
## ways using other Discovery techniques, because user and username details are prevalent throughout a system and
## include running process ownership, file/directory ownership, session information, and system logs. Adversaries
## may use the information from System Owner/User Discovery during automated discovery to shape follow-on behaviors,
## including whether or not the adversary fully infects the target and/or attempts specific actions.

## Various utilities and commands may acquire this information, including whoami. In macOS and Linux, the currently
## logged in user can be identified with w and who. On macOS the dscl . list /Users | grep -v '_' command can also
## be used to enumerate user accounts. Environment variables, such as %USERNAME% and $USER, may also be used to
## access this information.

## On network devices, Network Device CLI commands such as show users and show ssh can be used to display users
## currently logged into the device.

## Monitor execution of user discovery commands
##-a always,exit -F arch=b64 -S execve -F comm=id -F auid>=1000 -F auid!=4294967295 -k T1033_User_Discovery
##-a always,exit -F arch=b64 -S execve -F comm=whoami -F auid>=1000 -F auid!=4294967295 -k T1033_User_Discovery
##-a always,exit -F arch=b64 -S execve -F comm=who -F auid>=1000 -F auid!=4294967295 -k T1033_User_Discovery
##-a always,exit -F arch=b64 -S execve -F comm=w -F auid>=1000 -F auid!=4294967295 -k T1033_User_Discovery
## Covered by T1518
-a always,exit -F arch=b64 -S execve -F comm=finger -F auid>=1000 -F auid!=4294967295 -k T1033_User_Discovery
-a always,exit -F arch=b64 -S execve -F comm=users -F auid>=1000 -F auid!=4294967295 -k T1033_User_Discovery
-a always,exit -F arch=b64 -S execve -F comm=logname -F auid>=1000 -F auid!=4294967295 -k T1033_User_Discovery

## Monitor execution of user privilege discovery commands
-a always,exit -F arch=b64 -S execve -F comm=groups -F auid>=1000 -F auid!=4294967295 -k T1033_User_Privilege_Discovery
##-a always,exit -F arch=b64 -S execve -F comm=whoami -F auid>=1000 -F auid!=4294967295 -k T1033_User_Privilege_Discovery
##-a always,exit -F arch=b64 -S execve -F comm=sudo -F auid>=1000 -F auid!=4294967295 -k T1033_User_Privilege_Discovery

## Monitor access to user-related system files
##-w /etc/passwd -p r -k T1033_User_File_Access
##-w /etc/shadow -p r -k T1033_User_File_Access
##-w /etc/group -p r -k T1033_User_File_Access
##-w /var/run/utmp -p r -k T1033_Logged_In_Users
##-w /var/log/wtmp -p r -k T1033_User_Login_History
##-w /var/log/lastlog -p r -k T1033_User_Login_History
## Covered by TA0005


#############################################
## T1082 - System Information Discovery
##   Ref: https://attack.mitre.org/techniques/T1082/

## An adversary may attempt to get detailed information about the operating system and hardware, including version,
## patches, hotfixes, service packs, and architecture. Adversaries may use the information from System Information
## Discovery during automated discovery to shape follow-on behaviors, including whether or not the adversary fully
## nfects the target and/or attempts specific actions.

## Tools such as Systeminfo can be used to gather detailed system information. If running with privileged access,
## a breakdown of system data can be gathered through the systemsetup configuration tool on macOS. As an example,
## adversaries with user-level access can execute the df -aH command to obtain currently mounted disks and associated
## freely available space. Adversaries may also leverage a Network Device CLI on network devices to gather detailed
## system information (e.g. show version). System Information Discovery combined with information gathered from
## other forms of discovery and reconnaissance can drive payload development and concealment.

## Infrastructure as a Service (IaaS) cloud providers such as AWS, GCP, and Azure allow access to instance and
## virtual machine information via APIs. Successful authenticated API calls can return data such as the operating
## system platform and status of a particular instance or the model view of a virtual machine.

## Monitor execution of system information discovery commands
-a always,exit -F arch=b64 -S execve -F comm=uname -F auid>=1000 -F auid!=4294967295 -k T1082_System_Discovery
## Covered by T1518
## -a always,exit -F arch=b64 -S execve -F comm=hostname -F auid>=1000 -F auid!=4294967295 -k T1082_System_Discovery
## Covered by T1016
-a always,exit -F arch=b64 -S execve -F comm=uptime -F auid>=1000 -F auid!=4294967295 -k T1082_System_Discovery
-a always,exit -F arch=b64 -S execve -F comm=lsb_release -F auid>=1000 -F auid!=4294967295 -k T1082_System_Discovery
-a always,exit -F arch=b64 -S execve -F comm=cat -F path=/etc/os-release -F auid>=1000 -F auid!=4294967295 -k T1082_System_Discovery
-a always,exit -F arch=b64 -S execve -F comm=cat -F path=/etc/issue -F auid>=1000 -F auid!=4294967295 -k T1082_System_Discovery
-a always,exit -F arch=b64 -S execve -F comm=cat -F path=/proc/version -F auid>=1000 -F auid!=4294967295 -k T1082_System_Discovery

## Monitor execution of hardware information commands
-a always,exit -F arch=b64 -S execve -F comm=lscpu -F auid>=1000 -F auid!=4294967295 -k T1082_Hardware_Discovery
-a always,exit -F arch=b64 -S execve -F comm=dmidecode -F auid>=1000 -F auid!=4294967295 -k T1082_Hardware_Discovery
-a always,exit -F arch=b64 -S execve -F comm=lshw -F auid>=1000 -F auid!=4294967295 -k T1082_Hardware_Discovery
-a always,exit -F arch=b64 -S execve -F comm=lsblk -F auid>=1000 -F auid!=4294967295 -k T1082_Hardware_Discovery

## Monitor execution of system performance commands
##-a always,exit -F arch=b64 -S execve -F comm=top -F auid>=1000 -F auid!=4294967295 -k T1082_Performance_Discovery
-a always,exit -F arch=b64 -S execve -F comm=vmstat -F auid>=1000 -F auid!=4294967295 -k T1082_Performance_Discovery
-a always,exit -F arch=b64 -S execve -F comm=iostat -F auid>=1000 -F auid!=4294967295 -k T1082_Performance_Discovery
-a always,exit -F arch=b64 -S execve -F comm=free -F auid>=1000 -F auid!=4294967295 -k T1082_Performance_Discovery

## Monitor access to system configuration files
-w /etc/os-release -p r -k T1082_System_Config_Access
-w /etc/issue -p r -k T1082_System_Config_Access
-w /etc/hostname -p r -k T1082_System_Config_Access
-w /etc/machine-id -p r -k T1082_System_Config_Access
-w /proc/version -p r -k T1082_System_Config_Access
-w /etc/lsb-release -p r -k T1082_System_Config_Access
-w /etc/redhat-release -p r -k T1082_System_Config_Access
-w /etc/oracle-release -p r -k T1082_System_Config_Access
